stage('Build') {

  parallel (

      "app" : {

        node('standard') {

            git 'https://github.com/IvanDechovsky/Dev-Environment'
            sh 'sudo apt-get install curl'
            sh 'curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P chefdk -c stable -v 0.16.28'
            sh 'sudo dpkg --configure -a'
            sh 'sudo chef-client --local-mode --runlist \'recipe[webserver]\''
            git branch: 'dev', url: 'https://github.com/CameronC17/PokerGameFE'
            sh 'npm install'
            slackSend channel: '#pokerbalmz', color: 'good', message: 'Pimpline running through APP on test', teamDomain: 'spartaglobal'

            }

         },


     "api" : {

        node('standard') {

            git 'https://github.com/IvanDechovsky/Dev-Environment'
            sh 'curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P chefdk -c stable -v 0.16.28'
            sh 'sudo dpkg --configure -a'
            sh 'sudo chef-client --local-mode --runlist \'recipe[webserver]\''
            git branch: 'dev', url: 'https://github.com/CameronC17/PokerGameAPI'
            sh 'npm install mocha -g'
            sh 'npm install chai-http -g'
            sh 'npm install chai -g'
            sh 'sudo chef-client --local-mode --runlist \'recipe[db]\''
            sh 'npm install'
            sh 'mocha'
            sh 'pm2 kill'
            sh 'pm2 start app.js -f'
            slackSend channel: '#pokerbalmz', color: 'good', message: 'Pimpline running through API on test', teamDomain: 'spartaglobal'

               }

            }
    )
}


stage('production') {

parallel(



  "app" :{


        node('rat-papp') {
        sh 'sudo hostname app.production'
        git 'https://github.com/IvanDechovsky/Dev-Environment'
        sh 'sudo apt-get install curl'
        sh 'curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P chefdk -c stable -v 0.16.28'
        sh 'sudo dpkg --configure -a'
        sh 'sudo chef-client --local-mode --runlist \'recipe[webserver]\''
        git branch: 'dev', url: 'https://github.com/CameronC17/PokerGameFE'
        sh 'npm install'
        sh 'pm2 kill'
        sh 'pm2 start app.js -f'
        slackSend channel: '#pokerbalmz', color: 'good', message: 'Pimpline running through APP on test', teamDomain: 'spartaglobal'

            }
            },

    "api": {

        node('rat-papi') {

            git 'https://github.com/IvanDechovsky/Dev-Environment'
            sh 'sudo apt-get install curl'
            sh 'curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P chefdk -c stable -v 0.16.28'
            sh 'sudo dpkg --configure -a'
            sh 'sudo chef-client --local-mode --runlist \'recipe[webserver]\''
            git
            git branch: 'dev', url: 'https://github.com/CameronC17/PokerGameAPI'
            sh 'npm install'
            sh 'pm2 kill'
            sh 'pm2 start app.js -f'
            slackSend channel: '#pokerbalmz', color: 'good', message: 'Pimpline running through API on production', teamDomain: 'spartaglobal'

               }
               },

               "database": {



            node('rat-pdb') {

            git 'https://github.com/IvanDechovsky/Dev-Environment'
            sh 'sudo apt-get install curl'
            sh 'curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P chefdk -c stable -v 0.16.28'
            sh 'sudo dpkg --configure -a'
            sh 'sudo chef-client --local-mode --runlist \'recipe[db]\''

            slackSend channel: '#pokerbalmz', color: 'good', message: 'Pimpline running through database on production', teamDomain: 'spartaglobal'

            }
            }
            )



}
